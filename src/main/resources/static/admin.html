<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Mecon Asset Management</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      /* Base styles for the body */
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* Modern, readable font */
        display: flex;
        background-color: #eef2f7; /* Lighter, softer background */
        color: #333; /* Darker text for readability */
      }

      /* Sidebar styles */
      .sidebar {
        width: 60px; /* Collapsed width */
        background-color: #2c3e50; /* Dark blue-gray */
        color: white;
        height: 100vh;
        position: fixed; /* Fixed position */
        transition: width 0.3s ease-in-out; /* Smooth width transition */
        overflow: hidden; /* Hide overflowing text when collapsed */
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        z-index: 1000; /* Ensure sidebar is above other content */
      }

      .sidebar.expanded {
        width: 220px; /* Expanded width */
      }

      .sidebar .toggle-btn {
        display: flex; /* Use flex for alignment */
        align-items: center; /* Vertically align items */
        width: 100%;
        background: none;
        border: none;
        color: white;
        padding: 15px;
        font-size: 18px;
        cursor: pointer;
        text-align: left; /* Align text to left */
        gap: 10px; /* Space between icon and text */
        box-sizing: border-box; /* Include padding in width */
      }

      .sidebar .toggle-btn:hover {
        background-color: #34495e; /* Hover effect */
      }

      .sidebar nav {
        padding-top: 10px; /* Space below toggle button */
      }

      .sidebar a {
        display: flex;
        align-items: center;
        padding: 15px;
        color: white;
        text-decoration: none;
        transition: background 0.3s ease, color 0.3s ease; /* Smooth transitions */
        cursor: pointer;
        gap: 10px; /* Space between icon and text */
        white-space: nowrap; /* Prevent text wrapping */
      }

      .sidebar a:hover,
      .sidebar a.active-link {
        /* New class for active link */
        background-color: #34495e;
        color: #f0f0f0; /* Slightly lighter text on hover/active */
      }

      .sidebar i {
        margin-right: 0; /* Reset margin from previous setup */
        font-size: 18px;
        width: 20px; /* Fixed width for icons to prevent text jump */
        text-align: center;
      }

      .menu-text {
        display: none;
        opacity: 0; /* Start hidden */
        transition: opacity 0.3s ease-in-out; /* Fade in text */
      }

      .sidebar.expanded .menu-text {
        display: inline;
        opacity: 1; /* Fade in text */
      }

      /* Main content area styles */
      .content {
        margin-left: 60px; /* Initial margin to accommodate collapsed sidebar */
        padding: 20px;
        flex-grow: 1; /* Allows content to take up remaining space */
        transition: margin-left 0.3s ease-in-out; /* Smooth margin transition */
        box-sizing: border-box; /* Include padding in element's total width and height */
      }

      .sidebar.expanded ~ .content {
        margin-left: 220px; /* Margin when sidebar is expanded */
      }

      /* Section visibility */
      .section {
        display: none;
        background-color: #ffffff; /* White background for sections */
        padding: 25px;
        border-radius: 8px; /* Slightly rounded corners */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* More prominent shadow */
        margin-bottom: 20px; /* Space between sections if multiple active */
      }

      .section.active {
        display: block;
      }

      /* Headings */
      h1,
      h2,
      h3,
      h4 {
        color: #2c3e50; /* Darker headings */
        margin-top: 0; /* Remove default top margin */
        margin-bottom: 15px;
      }

      /* Asset category grid */
      .asset-category-grid {
        display: grid; /* Use grid for better control */
        grid-template-columns: repeat(
          auto-fill,
          minmax(160px, 1fr)
        ); /* Responsive grid */
        gap: 25px; /* Larger gap */
        margin-top: 20px;
      }

      .asset-card {
        border: 1px solid #e0e0e0; /* Lighter border */
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Enhanced shadow */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        background-color: #fff;
        display: flex; /* Flex for content alignment */
        flex-direction: column; /* Stack icon and text */
        justify-content: center; /* Center content vertically */
        align-items: center; /* Center content horizontally */
        min-height: 120px; /* Ensure cards have a minimum height */
      }

      .asset-card:hover {
        transform: translateY(-5px) scale(1.02); /* Slight lift and scale */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* More pronounced shadow on hover */
      }

      .asset-icon {
        font-size: 42px; /* Larger icon */
        margin-bottom: 12px;
        color: #3498db; /* Brighter blue */
        transition: color 0.3s ease;
      }
      .asset-card:hover .asset-icon {
        color: #2980b9; /* Slightly darker on hover */
      }

      /* Filter Controls */
      #assetFilterControls {
        background-color: #f9f9f9;
        border: 1px solid #eee;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
        display: flex; /* Use flexbox for layout */
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 20px; /* Space between filter elements */
        align-items: flex-end; /* Align items to the bottom */
      }

      #assetFilterControls label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        color: #555;
      }

      #assetFilterControls input[type="number"],
      #assetFilterControls select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        margin-top: 5px; /* Space between label and input */
        width: 150px; /* Fixed width for inputs */
      }

      #assetFilterControls button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      #assetFilterControls button:hover {
        background-color: #2980b9;
      }

      /* Asset List Table */
      #assetListTable table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden; /* Ensures rounded corners for table */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      #assetListTable th,
      #assetListTable td {
        border: 1px solid #e0e0e0;
        padding: 12px 15px; /* More padding */
        text-align: left;
      }

      #assetListTable th {
        background-color: #f2f2f2; /* Light gray header */
        color: #555;
        font-weight: 600; /* Slightly bolder */
        text-transform: uppercase; /* Uppercase headers */
        font-size: 14px;
      }

      #assetListTable tbody tr:nth-child(even) {
        background-color: #f9f9f9; /* Zebra striping */
      }

      #assetListTable tbody tr:hover {
        background-color: #eef7ff; /* Light blue on hover */
      }

      /* Add Asset Form Styles */
      #addAssetFormContainer {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-top: 20px;
        display: none; /* Hidden by default */
        flex-direction: column;
        gap: 15px;
      }

      #addAssetFormContainer h2 {
        color: #2c3e50;
        margin-bottom: 20px;
      }

      #newAssetForm {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
      }

      #newAssetForm label {
        font-weight: 500;
        color: #444;
      }

      #newAssetForm input[type="text"],
      #newAssetForm input[type="number"],
      #newAssetForm textarea,
      #newAssetForm select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box; /* Include padding in width */
      }

      #newAssetForm textarea {
        resize: vertical; /* Allow vertical resizing */
        min-height: 80px;
      }

      #newAssetForm .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end; /* Align buttons to the right */
        margin-top: 20px;
      }

      #newAssetForm .form-actions button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      #newAssetForm .form-actions button[type="submit"] {
        background-color: #28a745; /* Green for submit */
        color: white;
      }

      #newAssetForm .form-actions button[type="submit"]:hover {
        background-color: #218838;
      }

      #newAssetForm .form-actions button[type="button"] {
        /* For cancel button */
        background-color: #6c757d; /* Gray for cancel */
        color: white;
      }

      #newAssetForm .form-actions button[type="button"]:hover {
        background-color: #5a6268;
      }

      /* Custom Message Box */
      .message-box-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .message-box-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .message-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      .message-box-overlay.show .message-box {
        transform: translateY(0);
      }

      .message-box h3 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 20px;
        color: #2c3e50;
      }

      .message-box p {
        margin-bottom: 25px;
        font-size: 16px;
        color: #555;
      }

      .message-box button {
        padding: 10px 25px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      .message-box button:hover {
        background-color: #2980b9;
      }

      .message-box.error h3 {
        color: #dc3545; /* Red for error messages */
      }
      .message-box.success h3 {
        color: #28a745; /* Green for success messages */
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .sidebar {
          width: 0; /* Fully hidden on small screens initially */
        }
        .sidebar.expanded {
          width: 200px; /* Adjusted expanded width */
        }
        .content {
          margin-left: 0; /* No margin on small screens */
        }
        .sidebar.expanded ~ .content {
          margin-left: 200px; /* Margin when expanded */
        }
        .asset-category-grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
        #assetFilterControls {
          flex-direction: column; /* Stack filters vertically */
          align-items: stretch; /* Stretch items to full width */
        }
        #assetFilterControls input[type="number"],
        #assetFilterControls select {
          width: 100%; /* Full width inputs */
        }
        #newAssetForm {
          grid-template-columns: 1fr; /* Stack form fields vertically */
        }
      }

      .delete-icon {
        cursor: pointer;
        margin-left: 10px;
        color: rgb(255, 22, 22);
        font-size: 16px;
      }
      .edit-icon {
        cursor: pointer;
        margin-left: 10px;
        color: rgb(0, 205, 147);
        font-size: 16px;
      }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <button
            class="toggle-btn"
            onclick="toggleSidebar()"
            aria-expanded="false"
            aria-controls="main-navigation"
        >
            <i class="fas fa-th" aria-hidden="true"></i>
            <span class="menu-text">Mecon</span>
        </button>
        <nav id="main-navigation" aria-label="Main Navigation">
            <a
                href="#"
                id="dashboard-link"
                onclick="showSection('dashboard', this)"
                role="menuitem"
            >
                <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                <span class="menu-text">Dashboard</span>
            </a>
            <a
                href="#"
                id="manageAssets-link"
                onclick="showSection('manageAssets', this)"
                role="menuitem"
            >
                <i class="fas fa-box" aria-hidden="true"></i>
                <span class="menu-text">Manage Assets</span>
            </a>
            <a
                href="#"
                id="assignAssets-link"
                onclick="showSection('assignAssets', this)"
                role="menuitem"
            >
                <i class="fas fa-exchange-alt" aria-hidden="true"></i>
                <span class="menu-text">Assign Assets</span>
            </a>
            <a
                href="#"
                id="manageEmployees-link"
                onclick="showSection('manageEmployees', this)"
                role="menuitem"
            >
                <i class="fas fa-users" aria-hidden="true"></i>
                <span class="menu-text">Manage Employees</span>
            </a>
            <a
                href="#"
                id="reports-link"
                onclick="showSection('reports', this)"
                role="menuitem"
            >
                <i class="fas fa-chart-line" aria-hidden="true"></i>
                <span class="menu-text">Reports</span>
            </a>
            <a
                href="#"
                id="logout-link"
                onclick="showSection('logout', this)"
                role="menuitem"
            >
                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                <span class="menu-text">Logout</span>
            </a>
        </nav>
    </aside>

    <main class="content">
        <section
            id="dashboard"
            class="section active"
            aria-labelledby="dashboard-heading"
        >
            <h1 id="dashboard-heading">Dashboard</h1>
            <p>
                Welcome to your Asset Management Dashboard! Here you can get an
                overview of your assets and their statuses.
            </p>
        </section>

        <section
            id="manageAssets"
            class="section"
            aria-labelledby="manageAssets-heading"
        >
            <h1 id="manageAssets-heading">Manage Assets</h1>
            <p>Select an asset category below to view and manage its assets.</p>

            <div
                id="assetCategoryGrid"
                class="asset-category-grid"
                role="grid"
                aria-label="Asset Categories"
            >
                <p>Loading asset categories...</p>
            </div>

            <div id="assetFilterControls" style="margin-top: 30px; display: none">
                <h2>Filter Assets</h2>
                <label for="minPrice">Min Price:</label>
                <input
                    type="number"
                    id="minPrice"
                    placeholder="0"
                    min="0"
                    aria-label="Minimum price filter"
                />

                <label for="maxPrice">Max Price:</label>
                <input
                    type="number"
                    id="maxPrice"
                    placeholder="100000"
                    min="0"
                    aria-label="Maximum price filter"
                />

                <label for="statusFilter">Status:</label>
                <select id="statusFilter" aria-label="Asset status filter">
                    <option value="">All</option>
                    <option value="Available">Available</option>
                    <option value="Assigned">Assigned</option>
                    <option value="Under Maintenance">Maintenance</option>
                    <option value="Damaged">Damaged</option>
                    <option value="Retired">Retired</option>
                </select>

                <button onclick="applyAssetFilters()">Apply Filter</button>
                <button id="addAssetBtn" onclick="showAddAssetForm()">
                    Add Asset
                </button>
            </div>

            <div id="assetListTable" style="margin-top: 20px">
                </div>

            <div id="addAssetFormContainer">
                <h2>Add New Asset</h2>
                <form id="newAssetForm">
                    <label for="assetName">Asset Name:</label>
                    <input
                        type="text"
                        id="assetName"
                        required
                        aria-label="Asset Name"
                        placeholder="e.g., Laptop XYZ"
                    />

                    <label for="assetDescription">Description:</label>
                    <textarea
                        id="assetDescription"
                        rows="3"
                        aria-label="Asset Description"
                        placeholder="e.g., High-performance laptop for design team"
                    ></textarea>

                    <label for="assetValue">Value (â‚¹):</label>
                    <input
                        type="number"
                        id="assetValue"
                        min="0"
                        step="0.01"
                        required
                        aria-label="Asset Value in Rupees"
                        placeholder="e.g., 50000.00"
                    />

                    <label for="assetStatus">Status:</label>
                    <select id="assetStatus" required aria-label="Asset Status">
                        <option value="Available">Available</option>
                        <option value="Assigned">Assigned</option>
                        <option value="Under Maintenance">Under Maintenance</option>
                        <option value="Damaged">Damaged</option>
                        <option value="Retired">Retired</option>
                    </select>

                    <div class="form-actions">
                        <button type="submit">Add Asset</button>
                        <button type="button" onclick="hideAddAssetForm()">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <section
            id="assignAssets"
            class="section"
            aria-labelledby="assignAssets-heading"
        >
            <h1 id="assignAssets-heading">Assign Assets</h1>
            <p>
                Effortlessly assign and unassign assets to and from employees. Track
                who has what, and when.
            </p>
        </section>

        <section
            id="manageEmployees"
            class="section"
            aria-labelledby="manageEmployees-heading"
        >
            <h1 id="manageEmployees-heading">Manage Employees</h1>
            <p>
                Manage employee details, including their assigned assets and contact
                information.
            </p>
        </section>

        <section id="reports" class="section" aria-labelledby="reports-heading">
            <h1 id="reports-heading">Reports</h1>
            <p>
                Generate insightful reports on asset inventory, assignment history,
                and asset valuation.
            </p>
        </section>

        <section id="logout" class="section" aria-labelledby="logout-heading">
            <h1 id="logout-heading">Logout</h1>
            <p>
                Thank you for using the Mecon Asset Management System. You can
                securely log out here.
            </p>
            <button onclick="showMessageBox('Logging out...', 'info')">
                Proceed to Logout
            </button>
        </section>
    </main>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button onclick="hideMessageBox()">OK</button>
        </div>
    </div>

    <script>
        // Global variable to store active link for highlighting
       // ... (your existing global variables and functions) ...

// Global variable to store active link for highlighting
let activeSidebarLink = document.getElementById("dashboard-link");

// Global variable to store currently loaded assets for filtering
let currentAssets = [];
let currentCategoryId = null; // Store the ID of the currently selected category
let currentCategoryName = ""; // Store the name of the currently selected category

document.addEventListener("DOMContentLoaded", () => {
    // Initialize dashboard as active on load
    showSection("dashboard", activeSidebarLink);
});

/**
 * Toggles the expansion state of the sidebar.
 */
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.querySelector(".toggle-btn");
    sidebar.classList.toggle("expanded");

    // Update ARIA attributes for accessibility
    const isExpanded = sidebar.classList.contains("expanded");
    toggleBtn.setAttribute("aria-expanded", isExpanded);
}

/**
 * Shows the selected content section and updates the active sidebar link.
 * @param {string} id - The ID of the section to show.
 * @param {HTMLElement} clickedLink - The sidebar link element that was clicked.
 */
function showSection(id, clickedLink) {
    // Deactivate all sections
    const sections = document.querySelectorAll(".section");
    sections.forEach((sec) => sec.classList.remove("active"));

    // Deactivate previous active link
    if (activeSidebarLink) {
        activeSidebarLink.classList.remove("active-link");
    }

    // Activate the target section
    const target = document.getElementById(id);
    if (target) {
        target.classList.add("active");
        // Set the current clicked link as active
        if (clickedLink) {
            clickedLink.classList.add("active-link");
            activeSidebarLink = clickedLink; // Update global active link
        }

        // Special handling for 'manageAssets' section
        if (id === "manageAssets") {
            document.getElementById("addAssetFormContainer").style.display =
                "none"; // Hide form if navigating back
            renderAssetCategories();
        } else {
            // Hide asset filter controls and table when not in manageAssets
            document.getElementById("assetFilterControls").style.display =
                "none";
            document.getElementById("assetListTable").innerHTML = ""; // Clear table
            document.getElementById("addAssetFormContainer").style.display =
                "none"; // Hide add asset form
        }
    }
}

/**
 * Returns the appropriate Font Awesome icon class for a given asset category name.
 * @param {string} name - The name of the asset category.
 * @returns {string} The Font Awesome icon class.
 */
function getIconForCategory(name) {
    switch (name.toLowerCase()) {
        case "laptop":
            return "fa-laptop";
        case "computer":
            return "fa-desktop";
        case "mouse":
            return "fa-computer-mouse";
        case "keyboard":
            return "fa-keyboard";
        case "printer":
            return "fa-print";
        case "scanner":
            return "fa-expand"; // Updated to fa-scanner if available
        case "monitor":
            return "fa-monitor"; // Common asset
        case "software":
            return "fa-code"; // Generic for software licenses
        case "mobile phone":
            return "fa-mobile-screen";
        case "tablet":
            return "fa-tablet-alt";
        case "camera":
            return "fa-camera";
        case "projector":
            return "fa-video-projector"; // If available
        default:
            return "fa-boxes"; // Generic multiple boxes for unknown
    }
}

/**
 * Renders the asset category cards in the 'Manage Assets' section.
 * Fetches categories from the backend API.
 */
async function renderAssetCategories() {
    const grid = document.getElementById("assetCategoryGrid");
    grid.innerHTML = "<p>Loading asset categories...</p>"; // Show loading message
    grid.style.display = "grid"; // Ensure grid is visible

    try {
        // Fetch asset categories from your Spring Boot API
        const res = await fetch("/api/asset-categories");
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const categories = await res.json();

        if (categories.length === 0) {
            grid.innerHTML =
                "<p style='color: gray;'>No asset categories found.</p>";
            return;
        }

        grid.innerHTML = ""; // Clear loading message

        categories.forEach((cat) => {
            const iconClass = getIconForCategory(cat.name);
            const card = document.createElement("div");
            card.className = "asset-card";
            // Add ARIA attributes for grid items
            card.setAttribute("role", "gridcell");
            card.setAttribute("tabindex", "0"); // Make div focusable
            card.setAttribute("aria-label", `View ${cat.name} assets`);
            card.innerHTML = `
                <div class="asset-icon"><i class="fas ${iconClass}" aria-hidden="true"></i></div>
                <h3>${cat.name}</h3>
            `;
            // Use a common function for click handler to pass both ID and Name
            card.onclick = () => showAssetsTable(cat.id, cat.name);
            // Add keyboard accessibility for Enter key
            card.onkeydown = (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault(); // Prevent default scroll for space bar
                    showAssetsTable(cat.id, cat.name);
                }
            };
            grid.appendChild(card);
        });
    } catch (err) {
        grid.innerHTML = `<p style='color:red;'>Error loading categories: ${err.message}. Please ensure your Spring Boot backend is running and accessible.</p>`;
        console.error("Failed to load asset categories:", err);
    }
}

/**
 * Fetches and displays assets for a specific category in a table.
 * @param {number} categoryId - The ID of the selected asset category.
 * @param {string} categoryName - The name of the selected asset category.
 */
async function showAssetsTable(categoryId, categoryName) {
    const tableWrapper = document.getElementById("assetListTable");
    const filterSection = document.getElementById("assetFilterControls");
    const categoryGrid = document.getElementById("assetCategoryGrid");

    currentCategoryId = categoryId; // Store the category ID
    currentCategoryName = categoryName; // Store the category name for later use

    categoryGrid.style.display = "grid"; // Keep category grid visible as per previous request
    filterSection.style.display = "flex"; // Ensure filter controls are visible
    tableWrapper.style.display = "block"; // Ensure table wrapper is visible
    document.getElementById("addAssetFormContainer").style.display = "none"; // Hide add asset form

    tableWrapper.innerHTML = `<p>Loading assets for <strong>${categoryName}</strong>...</p>`; // Loading message

    try {
        // Fetch assets for the specific category from your Spring Boot API
        const res = await fetch(`/api/assets/category/${categoryId}`);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        currentAssets = await res.json(); // Save to global variable

        if (currentAssets.length === 0) {
            tableWrapper.innerHTML = `<p style='color: gray;'>No assets found in the <strong>${categoryName}</strong> category.</p>`;
            return;
        }

        renderAssetTable(currentAssets); // Render the table with all fetched assets
    } catch (err) {
        tableWrapper.innerHTML = `<p style='color:red;'>Failed to load assets: ${err.message}.</p>`;
        console.error("Failed to load assets for category:", err);
    }
}

/**
 * Applies filters (min price, max price, status) to the currently loaded assets
 * and re-renders the asset table.
 */
function applyAssetFilters() {
    const min = parseFloat(document.getElementById("minPrice").value) || 0;
    const max =
        parseFloat(document.getElementById("maxPrice").value) ||
        Number.MAX_VALUE;
    const status = document.getElementById("statusFilter").value;

    // Filter the global `currentAssets` array
    const filtered = currentAssets.filter((asset) => {
        const price = parseFloat(asset.value);
        const matchesPrice = price >= min && price <= max;
        const matchesStatus = status ? asset.status === status : true; // If status is empty, match all statuses
        return matchesPrice && matchesStatus;
    });

    renderAssetTable(filtered); // Render the table with filtered assets
}

/**
 * Renders an array of asset objects into an HTML table.
 * @param {Array<Object>} assets - An array of asset objects to display.
 */
function renderAssetTable(assets) {
    const tableWrapper = document.getElementById("assetListTable");
    if (assets.length === 0) {
        tableWrapper.innerHTML =
            "<p style='color: gray;'>No assets match the current filters.</p>";
        return;
    }

    const table = document.createElement("table");
    table.setAttribute("role", "table");
    table.setAttribute(
        "aria-label",
        `List of ${currentCategoryName} Assets`
    ); // Dynamic ARIA label

    table.innerHTML = `
        <thead>
            <tr>
                <th role="columnheader">Name</th>
                <th role="columnheader">Description</th>
                <th role="columnheader">Status</th>
                <th role="columnheader">Value (â‚¹)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            ${assets
                .map(
                    (asset) => `
                <tr role="row">
                    <td role="cell">${asset.name}</td>
                    <td role="cell">${asset.description}</td>
                    <td role="cell">${asset.status}</td>
                    <td role="cell">${
                        asset.value
                            ? asset.value.toLocaleString("en-IN", {
                                  style: "currency",
                                  currency: "INR",
                              })
                            : "N/A"
                    }</td>
                    <td class="action-cell">
                        <span class="delete-icon" data-id="${
                            asset.id
                        }" title="Delete Asset"><i class="fa-solid fa-trash"></i></span>
                        <span class="edit-icon" data-id="${asset.id}" title="Edit Asset"><i class="fa-solid fa-pen"></i></span>
                    </td>
                </tr>
            `
                )
                .join("")}
        </tbody>
    `;
    tableWrapper.innerHTML = ""; // Clear previous content
    tableWrapper.appendChild(table);

    // Attach event listeners for Delete buttons
    const deleteIcons = table.querySelectorAll(".delete-icon");
    deleteIcons.forEach((icon) => {
        icon.addEventListener("click", async function () {
            const assetId = this.getAttribute("data-id");
            if (confirm("Are you sure you want to delete this asset?")) {
                try {
                    const response = await fetch(`/api/assets/${assetId}`, {
                        method: "DELETE",
                    });
                    if (response.ok) {
                        showMessageBox("Asset deleted successfully", "success");
                        // Re-fetch and re-render the table after deletion
                        showAssetsTable(currentCategoryId, currentCategoryName);
                    } else {
                        const errorText = await response.text();
                        showMessageBox(`Failed to delete asset: ${errorText}`, "error");
                    }
                } catch (error) {
                    showMessageBox("Network error while deleting", "error");
                    console.error("Delete error:", error);
                }
            }
        });
    });

    // Attach event listeners for Edit buttons
    const editIcons = table.querySelectorAll(".edit-icon");
    editIcons.forEach((icon) => {
        icon.addEventListener("click", function () {
            const assetId = this.getAttribute("data-id");
            // Find the asset object from the globally stored currentAssets array
            const assetToEdit = currentAssets.find((a) => a.id == assetId);

            if (!assetToEdit) {
                showMessageBox("Asset not found for editing", "error");
                return;
            }

            // Call showAddAssetForm() first to reset and show the form container
            showAddAssetForm();

            // ðŸ”¥ðŸ”¥ðŸ”¥ THIS IS THE CRUCIAL PART: PRE-FILL THE FORM FIELDS ðŸ”¥ðŸ”¥ðŸ”¥
            document.getElementById("assetName").value = assetToEdit.name;
            document.getElementById("assetDescription").value = assetToEdit.description;
            document.getElementById("assetValue").value = assetToEdit.value;
            document.getElementById("assetStatus").value = assetToEdit.status;

            // Set the form in edit mode by storing the asset ID
            document.getElementById("newAssetForm").setAttribute("data-edit-id", assetId);

            // Update the form title and button text for edit mode
            document.querySelector("#addAssetFormContainer h2").textContent = "Edit Asset";
            document.querySelector("#newAssetForm button[type='submit']").textContent = "Update Asset";
        });
    });
}

/**
 * Shows the "Add New Asset" form and hides other asset management elements.
 * This function is now smart enough to either prepare for adding or for editing.
 */
function showAddAssetForm() {
    document.getElementById("assetCategoryGrid").style.display = "none"; // Hide category grid
    document.getElementById("assetFilterControls").style.display = "none"; // Hide filters
    document.getElementById("assetListTable").style.display = "none"; // Hide asset table
    document.getElementById("addAssetFormContainer").style.display = "flex"; // Show the form

    // Reset form fields
    document.getElementById("newAssetForm").reset();

    // Default to "Add New Asset" mode
    document.querySelector("#addAssetFormContainer h2").textContent = "Add New Asset";
    document.querySelector("#newAssetForm button[type='submit']").textContent = "Add Asset";
    document.getElementById("newAssetForm").removeAttribute("data-edit-id"); // Clear any previous edit ID
}

/**
 * Hides the "Add New Asset" form and brings back the category grid or asset table/filters.
 */
function hideAddAssetForm() {
    document.getElementById("addAssetFormContainer").style.display = "none";

    // Debug: Show what currentCategoryId is
    console.log("Hiding form. Current Category ID:", currentCategoryId);

    if (
        currentCategoryId !== null &&
        typeof currentCategoryId !== "undefined"
    ) {
        // Show filter and asset list if a category is selected
        document.getElementById("assetFilterControls").style.display = "flex";
        document.getElementById("assetListTable").style.display = "block";

        // Re-render or re-fetch assets
        showAssetsTable(currentCategoryId, currentCategoryName); // Always re-fetch to ensure latest data
    } else {
        // No category selected â€“ show the grid again
        document.getElementById("assetCategoryGrid").style.display = "grid";
    }
    // Ensure form is reset to "Add" mode when hidden
    document.querySelector("#addAssetFormContainer h2").textContent = "Add New Asset";
    document.querySelector("#newAssetForm button[type='submit']").textContent = "Add Asset";
    document.getElementById("newAssetForm").removeAttribute("data-edit-id");
}

function showMessageBox(message, type = "info", title = "") {
    const overlay = document.getElementById("messageBoxOverlay");
    const messageBox = overlay.querySelector(".message-box");
    const messageBoxTitle = document.getElementById("messageBoxTitle");
    const messageBoxContent = document.getElementById("messageBoxContent");

    // Reset classes
    messageBox.classList.remove("success", "error", "info");
    messageBox.classList.add(type);

    // Set title based on type if not provided
    if (!title) {
        switch (type) {
            case "success":
                title = "Success!";
                break;
            case "error":
                title = "Error!";
                break;
            case "info":
                title = "Information";
                break;
            default:
                title = "Notification";
        }
    }

    messageBoxTitle.textContent = title;
    messageBoxContent.textContent = message;
    overlay.classList.add("show");
}

function hideMessageBox() {
    document.getElementById("messageBoxOverlay").classList.remove("show");
}

document
    .getElementById("newAssetForm")
    .addEventListener("submit", async function (event) {
        event.preventDefault();

        const assetId = this.getAttribute("data-edit-id"); // Get asset ID if in edit mode
        const assetName = document.getElementById("assetName").value;
        const assetDescription =
            document.getElementById("assetDescription").value;
        const assetValue = parseFloat(document.getElementById("assetValue").value);
        const assetStatus = document.getElementById("assetStatus").value;

        if (
            !assetName ||
            isNaN(assetValue) ||
            assetValue < 0 ||
            !assetStatus ||
            currentCategoryId === null
        ) {
            showMessageBox(
                "Please fill in all required fields and select a category.",
                "error"
            );
            return;
        }

        const payload = {
            name: assetName,
            description: assetDescription,
            value: assetValue,
            status: assetStatus,
            categoryId: currentCategoryId, // Always send categoryId
        };

        const method = assetId ? "PUT" : "POST";
        const endpoint = assetId ? `/api/assets/${assetId}` : `/api/assets`;

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                showMessageBox(assetId ? "Asset updated!" : "Asset added!", "success");
                hideAddAssetForm(); // This will re-fetch and re-render the table
            } else {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                showMessageBox(`Error: ${errorData.message}`, "error");
                console.error("API Error:", errorData);
            }
        } catch (error) {
            showMessageBox(`Network error: ${error.message}`, "error");
            console.error("Fetch error:", error);
        }
    });

// Initialize the dashboard on page load
document.addEventListener("DOMContentLoaded", () => {
    showSection("dashboard", document.getElementById("dashboard-link"));
});
    </script>
</body>
</html>