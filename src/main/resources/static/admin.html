<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Mecon Asset Management</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/admin.css" />
    <style>
.section.active {
    display: block; /* Show active section */
}

.dashboard-cards {
    display: flex;
    flex-wrap: wrap; /* Allows cards to wrap on smaller screens */
    gap: 20px;
    margin-top: 20px;
    justify-content: center; /* Center cards horizontally */
}

.dashcard {
    flex: 1; /* Allow cards to grow and shrink */
    min-width: 250px; /* Minimum width for cards */
    padding: 25px;
    background: #f9f9f9;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    font-size: 1.1em;
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.dashcard:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.dashcard span {
    display: block;
    font-size: 2.2em;
    font-weight: bold;
    color: #4CAF50;
    margin-top: 10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .dashboard-cards {
        flex-direction: column;
        align-items: center;
    }
    .dashcard {
        width: 90%; /* Take more width on small screens */
        min-width: unset;
    }
}

@media (max-width: 480px) {
    nav ul {
        flex-direction: column;
    }
    nav ul li {
        margin: 5px 0;
    }
}</style>
  </head>
  <body>
    <!-- Slidebar -->
    <aside class="sidebar" id="sidebar">
      <button
        class="toggle-btn"
        onclick="toggleSidebar()"
        aria-expanded="false"
        aria-controls="main-navigation"
      >
        <i class="fas fa-th" aria-hidden="true"></i>
        <span class="menu-text">Mecon</span>
      </button>
      <nav id="main-navigation" aria-label="Main Navigation">
        <a
          href="#"
          id="dashboard-link"
          onclick="showSection('dashboard', this)"
          role="menuitem"
        >
          <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
          <span class="menu-text">Dashboard</span>
        </a>
        <a
          href="#"
          id="manageAssets-link"
          onclick="showSection('manageAssets', this)"
          role="menuitem"
        >
          <i class="fas fa-box" aria-hidden="true"></i>
          <span class="menu-text">Manage Assets</span>
        </a>
        <a
          href="#"
          id="assignAssets-link"
          onclick="showSection('assignAssets', this)"
          role="menuitem"
        >
          <i class="fas fa-exchange-alt" aria-hidden="true"></i>
          <span class="menu-text">Assign Assets</span>
        </a>
        <a
          href="#"
          id="manageEmployees-link"
          onclick="showSection('manageEmployees', this)"
          role="menuitem"
        >
          <i class="fas fa-users" aria-hidden="true"></i>
          <span class="menu-text">Manage Employees</span>
        </a>
        <a
          href="#"
          id="reports-link"
          onclick="showSection('reports', this)"
          role="menuitem"
        >
          <i class="fas fa-chart-line" aria-hidden="true"></i>
          <span class="menu-text">Reports</span>
        </a>
        <a
          href="#"
          id="logout-link"
          onclick="showSection('logout', this)"
          role="menuitem"
        >
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
          <span class="menu-text">Logout</span>
        </a>
      </nav>
    </aside>
    <!-- Slidebar -->

    <main class="content">
      <!-- Dashboard -->
 <section id="dashboard" class="section active" aria-labelledby="dashboard-heading">
                <h1 id="dashboard-heading">Dashboard</h1>
                <p>Welcome to your Asset Management Dashboard! Here you can get an overview of your assets and their statuses.</p>

                <div id="dashboardSummary" class="dashboard-cards">
                    <div class="dashcard">Total Assets: <span id="totalAssets">Loading...</span></div>
                    <div class="dashcard">Available Assets: <span id="availableAssets">Loading...</span></div>                    <div class="dashcard">Assigned Assets: <span id="assignedAssets">Loading...</span></div>
                    <div class="dashcard">Assets in Maintenance: <span id="assetsInMaintenance">Loading...</span></div>
                    <div class="dashcard">Total Employees: <span id="totalEmployees">Loading...</span></div>
                </div>
            </section>
<!-- Manage assets -->
      <section
        id="manageAssets"
        class="section"
        aria-labelledby="manageAssets-heading"
      >
        <h1 id="manageAssets-heading">Manage Assets</h1>
        <p>Select an asset category below to view and manage its assets.</p>

        <div
          id="assetCategoryGrid"
          class="asset-category-grid"
          role="grid"
          aria-label="Asset Categories"
        >
          <p>Loading asset categories...</p>
        </div>

        <div id="assetFilterControls" style="margin-top: 30px; display: none">
          <h2>Filter Assets</h2>
          <label for="minPrice">Min Price:</label>
          <input
            type="number"
            id="minPrice"
            placeholder="0"
            min="0"
            aria-label="Minimum price filter"
          />

          <label for="maxPrice">Max Price:</label>
          <input
            type="number"
            id="maxPrice"
            placeholder="100000"
            min="0"
            aria-label="Maximum price filter"
          />

          <label for="statusFilter">Status:</label>
          <select id="statusFilter" aria-label="Asset status filter">
            <option value="">All</option>
            <option value="Available">Available</option>
            <option value="Assigned">Assigned</option>
            <option value="Under Maintenance">Maintenance</option>
          </select>

          <button onclick="applyAssetFilters()">Apply Filter</button>
          <button id="addAssetBtn" onclick="showAddAssetForm()">
            Add Asset
          </button>
        </div>

        <div id="assetListTable" style="margin-top: 20px"></div>

        <div id="addAssetFormContainer">
          <h2>Add New Asset</h2>
          <form id="newAssetForm">
            <label for="assetName">Asset Name:</label>
            <input
              type="text"
              id="assetName"
              required
              aria-label="Asset Name"
              placeholder="e.g., Laptop XYZ"
            />

            <label for="assetDescription">Description:</label>
            <textarea
              id="assetDescription"
              rows="3"
              aria-label="Asset Description"
              placeholder="e.g., High-performance laptop for design team"
            ></textarea>

            <label for="assetValue">Value (â‚¹):</label>
            <input
              type="number"
              id="assetValue"
              min="0"
              step="0.01"
              required
              aria-label="Asset Value in Rupees"
              placeholder="e.g., 50000.00"
            />

            <label for="assetStatus">Status:</label>
            <select id="assetStatus" required aria-label="Asset Status">
              <option value="Available">Available</option>
              <option value="Under Maintenance">Under Maintenance</option>
            </select>
            <label for="assetCategory">Category:</label>
            <select id="assetCategory" required aria-label="Asset Category">
              <option value="">-- Select Category --</option>
              <!-- JS will populate the rest -->
            </select>

            <div class="form-actions">
              <button type="submit">Add Asset</button>
              <button type="button" onclick="hideAddAssetForm()">Cancel</button>
            </div>
          </form>
        </div>
      </section>

    <div class="container">
        <section id="assignAssets" class="section" aria-labelledby="assignAssets-heading">
            <h1 id="assignAssets-heading" class="section-heading">Assign Assets</h1>
            <p class="section-description">
                Effortlessly assign and unassign assets to and from employees. Track
                who has what, and when.
            </p>

            <form id="assignForm" class="assign-form">
                <label for="assetSelect" class="form-label">Select Asset:</label>
                <select id="assetSelect" name="assetId" class="form-select"></select>

                <label for="employeeIdInput" class="form-label">Assign To (Employee ID):</label>
                <input type="text" id="employeeIdInput" name="employeeId" class="form-input" placeholder="Enter Employee ID" required>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>

            <div id="assignResult" class="result-message"></div>
        </section>
    </div>

<!-- Manage Employees  -->
    <section
      id="manageEmployees"
      class="section"
      aria-labelledby="manageEmployees-heading"
    >
      <h1 id="manageEmployees-heading">Manage Employees</h1>
      <p>Select a department below to view and manage its employees.</p>

      <!-- Removed User ID display as it's not relevant for a direct backend connection -->

      <div
        id="departmentCategoryGrid"
        class="department-category-grid"
        role="grid"
        aria-label="Employee Departments"
      >
        <p>Loading departments...</p>
      </div>

     <div id="employeeFilterControls" style="margin-top: 30px; display: none">
  <h2>Filter Employees</h2>

  <label for="employeeNameFilter">Name:</label>
  <input
    type="text"
    id="employeeNameFilter"
    placeholder="e.g., John Doe"
    aria-label="Filter by Employee Name"
  />

  <label for="employeeEmailFilter">Email:</label>
  <input
    type="text"
    id="employeeEmailFilter"
    placeholder="e.g., john@example.com"
    aria-label="Filter by Employee Email"
  />

  <label for="employeePhoneFilter">Phone:</label>
  <input
    type="text"
    id="employeePhoneFilter"
    placeholder="e.g., 9876543210"
    aria-label="Filter by Employee Phone Number"
  />

  <label for="joinDateMin">Min Join Date:</label>
  <input
    type="date"
    id="joinDateMin"
    aria-label="Minimum Join Date filter"
  />

  <label for="joinDateMax">Max Join Date:</label>
  <input
    type="date"
    id="joinDateMax"
    aria-label="Maximum Join Date filter"
  />

  <button onclick="applyEmployeeFilters()">Apply Filter</button>
  
  <button id="addEmployeeBtn" onclick="showAddEmployeeForm()">Add Employee</button>
</div>
      <div id="employeeListTable" style="margin-top: 20px"></div>

      <div id="addEmployeeFormContainer" style="display: none">
        <h2>Add New Employee</h2>
        <form id="newEmployeeForm">
          <label for="employeeName">Employee Name:</label>
          <input
            type="text"
            id="employeeName"
            required
            aria-label="Employee Name"
            placeholder="e.g., John Doe"
            class="rounded-md"
          />

          <label for="employeeEmail">Email:</label>
          <input
            type="email"
            id="employeeEmail"
            required
            aria-label="Employee Email"
            placeholder="e.g., john.doe@example.com"
            class="rounded-md"
          />

          <label for="employeePhone">Phone:</label>
          <input
            type="tel"
            id="employeePhone"
            aria-label="Employee Phone Number"
            placeholder="e.g., +91-9876543210"
            class="rounded-md"
          />

          <label for="employeeJoinDate">Join Date:</label>
          <input
            type="date"
            id="employeeJoinDate"
            required
            aria-label="Employee Join Date"
            class="rounded-md"
          />

          <label for="employeeDepartment">Department:</label>
          <select
            id="employeeDepartment"
            required
            aria-label="Employee Department"
            class="rounded-md"
          >
            <option value="">-- Select Department --</option>
            <!-- JS will populate the rest -->
          </select>

          <label for="employeeDesignation">Designation:</label>
          <input
            type="text"
            id="employeeDesignation"
            required
            aria-label="Employee Designation"
            placeholder="e.g., Software Engineer"
            class="rounded-md"
          />

          <div class="form-actions">
            <button type="submit" class="rounded-md">Add Employee</button>
            <button type="button" onclick="hideAddEmployeeForm()" class="rounded-md">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </section>


  <section id="reports" class="section" aria-labelledby="reports-heading">
        <h1 id="reports-heading">Reports</h1>
        <p>Generate insightful reports on asset inventory, assignment history, and asset valuation.</p>

        <div class="report-controls">
            <div class="form-group">
                <label for="reportType">Select Report Type:</label>
                <select id="reportType" name="reportType" class="form-control">
                    <option value="">-- Select --</option>
                    <option value="assetInventory">Asset Inventory Report</option>
                    <option value="employeeDetails">Employee Details Report</option>
                </select>
            </div>

            <div class="form-group filter-category" style="display:none;">
                <label for="filterCategory">Asset Category:</label>
                <select id="filterCategory" name="filterCategory" class="form-control"></select>
            </div>

            <div class="form-group filter-status" style="display:none;">
                <label for="filterStatus">Asset Status:</label>
                <select id="filterStatus" name="filterStatus" class="form-control">
                    <option value="">All</option>
                    <option value="ASSIGNED">Assigned</option>
                    <option value="UNDER_MAINTENANCE">Under Maintenance</option>
                    <option value="AVAILABLE">Available</option>
                </select>
            </div>

            <div class="form-group filter-department" style="display:none;">
                <label for="filterDepartment">Department:</label>
                <select id="filterDepartment" name="filterDepartment" class="form-control"></select>
            </div>

            <div class="form-group filter-join-date-start" style="display:none;">
                <label for="filterJoinDateStart">Join Date (Start):</label>
                <input type="date" id="filterJoinDateStart" name="filterJoinDateStart" class="form-control">
            </div>

            <div class="form-group filter-join-date-end" style="display:none;">
                <label for="filterJoinDateEnd">Join Date (End):</label>
                <input type="date" id="filterJoinDateEnd" name="filterJoinDateEnd" class="form-control">
            </div>

            <button id="generateReportBtn" class="btn btn-primary">Generate Report</button>
        </div>

        <div class="report-display">
            <h2 id="reportTitle" style="display:none;">Generated Report</h2>
            <div id="reportContent" class="table-responsive">
                <p id="noReportMessage">Please select a report type and click "Generate Report".</p>
            </div>
        </div>

        <div class="report-actions" style="display:none;">
            <button id="downloadPdfBtn" class="btn btn-success">Download PDF</button>
            <button id="downloadCsvBtn" class="btn btn-info">Download CSV</button>
            <button id="printReportBtn" class="btn btn-secondary">Print Report</button>
        </div>
    </section>
<!-- logout button -->
      <section id="logout" class="section" aria-labelledby="logout-heading">
        <h1 id="logout-heading">Logout</h1>
        <p>
          Thank you for using the Mecon Asset Management System. You can
          securely log out here.
        </p>
        <button onclick="handleLogout()">Proceed to Logout</button>
      </section>
    </main>

    <div id="messageBoxOverlay" class="message-box-overlay">
      <div class="message-box">
        <h3 id="messageBoxTitle"></h3>
        <p id="messageBoxContent"></p>
        <button onclick="hideMessageBox()">OK</button>
      </div>
    </div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
    <script>
       fetch("/api/current-admin")
    .then(response => {
      if (!response.ok) {
        throw new Error("Unauthorized or session expired");
      }
      return response.text();
    })
    .then(data => {
      console.log("Admin session is active.");
      // You can continue loading admin-specific data here
    })
    .catch(error => {
      alert("Session expired or unauthorized. Redirecting to login...");
      window.location.href = "/index.html";
    });
    // Global variable to store active link for highlighting
let activeSidebarLink = document.getElementById("dashboard-link");

// Global variable to store currently loaded assets for filtering
let currentAssets = [];
let currentCategoryId = null;
let currentCategoryName = "";

// Handle initial load
document.addEventListener("DOMContentLoaded", () => {
  showSection("dashboard", activeSidebarLink);

  // Setup sidebar nav link click listeners
  document.querySelectorAll(".nav-link").forEach(link => {
    link.addEventListener("click", event => {
      event.preventDefault();
      const sectionId = link.getAttribute("data-section");
      showSection(sectionId, link);
    });
  });
});

/**
 * Toggles the expansion state of the sidebar.
 */
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.querySelector(".toggle-btn");
  sidebar.classList.toggle("expanded");

  // Update ARIA attributes for accessibility
  const isExpanded = sidebar.classList.contains("expanded");
  toggleBtn.setAttribute("aria-expanded", isExpanded);
}

/**
 * Shows the selected content section and updates the active sidebar link.
 * @param {string} id - The ID of the section to show.
 * @param {HTMLElement} clickedLink - The sidebar link element that was clicked.
 */
function showSection(id, clickedLink) {
  // Deactivate all sections
  document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));

  // Deactivate previous active link
  if (activeSidebarLink) {
    activeSidebarLink.classList.remove("active-link");
  }

  // Activate the target section
  const target = document.getElementById(id);
  if (target) {
    target.classList.add("active");

    if (clickedLink) {
      clickedLink.classList.add("active-link");
      activeSidebarLink = clickedLink;
    }

    if (id === "dashboard") {
      loadDashboardData();
    }

    if (id === "manageAssets") {
      document.getElementById("addAssetFormContainer").style.display = "none";
      renderAssetCategories();
    } else {
      document.getElementById("assetFilterControls").style.display = "none";
      document.getElementById("assetListTable").innerHTML = "";
      document.getElementById("addAssetFormContainer").style.display = "none";
    }
  }
}

/**
 * Fetches dashboard data from the backend API and updates the HTML.
 */
async function loadDashboardData() {
  try {
    const res = await fetch("http://localhost:8080/api/dashboard");
    if (!res.ok) {
      throw new Error(`Failed to fetch dashboard data: ${res.statusText}`);
    }

    const data = await res.json();
    document.getElementById("totalAssets").textContent = data.totalAssets;
    document.getElementById("assignedAssets").textContent = data.assignedAssets;
    document.getElementById("availableAssets").textContent = data.availableAssets;
    document.getElementById("assetsInMaintenance").textContent = data.assetsInMaintenance;
    document.getElementById("totalEmployees").textContent = data.totalEmployees;
  } catch (err) {
    console.error("Dashboard fetch error:", err);
    const dashboardSummary = document.getElementById("dashboardSummary");
    if (dashboardSummary) {
      dashboardSummary.innerHTML = "<p style='color: red; text-align: center;'>Error loading dashboard data. Please try again later.</p>";
    }
  }
}


      /**
       * Returns the appropriate Font Awesome icon class for a given asset category name.
       * @param {string} name - The name of the asset category.
       * @returns {string} The Font Awesome icon class.
       */
      function getIconForCategory(name) {
        switch (name.toLowerCase()) {
          case "laptop":
            return "fa-laptop";
          case "computer":
            return "fa-desktop";
          case "mouse":
            return "fa-computer-mouse";
          case "keyboard":
            return "fa-keyboard";
          case "printer":
            return "fa-print";
          case "scanner":
            return "fa-expand"; // Updated to fa-scanner if available
          case "monitor":
            return "fa-monitor"; // Common asset
          case "software":
            return "fa-code"; // Generic for software licenses
          case "mobile phone":
            return "fa-mobile-screen";
          case "tablet":
            return "fa-tablet-alt";
          case "camera":
            return "fa-camera";
          case "projector":
            return "fa-video-projector"; // If available
          default:
            return "fa-boxes"; // Generic multiple boxes for unknown
        }
      }

      /**
       * Renders the asset category cards in the 'Manage Assets' section.
       * Fetches categories from the backend API.
       */
      async function renderAssetCategories() {
        const grid = document.getElementById("assetCategoryGrid");
        grid.innerHTML = "<p>Loading asset categories...</p>"; // Show loading message
        grid.style.display = "grid"; // Ensure grid is visible

        try {
          // Fetch asset categories from your Spring Boot API
          const res = await fetch("/api/asset-categories");
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          const categories = await res.json();

          if (categories.length === 0) {
            grid.innerHTML =
              "<p style='color: gray;'>No asset categories found.</p>";
            return;
          }

          grid.innerHTML = ""; // Clear loading message

          categories.forEach((cat) => {
            const iconClass = getIconForCategory(cat.name);
            const card = document.createElement("div");
            card.className = "card";
            // Add ARIA attributes for grid items
            card.setAttribute("role", "gridcell");
            card.setAttribute("tabindex", "0"); // Make div focusable
            card.setAttribute("aria-label", `View ${cat.name} assets`);
            card.innerHTML = `
                            <div class="asset-icon"><i class="fas ${iconClass}" aria-hidden="true"></i></div>
                            <h3>${cat.name}</h3>
                        `;
            // Use a common function for click handler to pass both ID and Name
            card.onclick = () => showAssetsTable(cat.id, cat.name);
            // Add keyboard accessibility for Enter key
            card.onkeydown = (event) => {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault(); // Prevent default scroll for space bar
                showAssetsTable(cat.id, cat.name);
              }
            };
            grid.appendChild(card);
          });
        } catch (err) {
          grid.innerHTML = `<p style='color:red;'>Error loading categories: ${err.message}. Please ensure your Spring Boot backend is running and accessible.</p>`;
          console.error("Failed to load asset categories:", err);
        }
      }

      /**
       * Fetches and displays assets for a specific category in a table.
       * @param {number} categoryId - The ID of the selected asset category.
       * @param {string} categoryName - The name of the selected asset category.
       */
      async function showAssetsTable(categoryId, categoryName) {
        const tableWrapper = document.getElementById("assetListTable");
        const filterSection = document.getElementById("assetFilterControls");
        const categoryGrid = document.getElementById("assetCategoryGrid");

        currentCategoryId = categoryId; // Store the category ID
        currentCategoryName = categoryName; // Store the category name for later use

        categoryGrid.style.display = "grid"; // Keep category grid visible as per previous request
        filterSection.style.display = "flex"; // Ensure filter controls are visible
        tableWrapper.style.display = "block"; // Ensure table wrapper is visible
        document.getElementById("addAssetFormContainer").style.display = "none"; // Hide add asset form

        tableWrapper.innerHTML = `<p>Loading assets for <strong>${categoryName}</strong>...</p>`; // Loading message

        try {
          // Fetch assets for the specific category from your Spring Boot API
          const res = await fetch(`/api/assets/category/${categoryId}`);
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          currentAssets = await res.json(); // Save to global variable

          if (currentAssets.length === 0) {
            tableWrapper.innerHTML = `<p style='color: gray;'>No assets found in the <strong>${categoryName}</strong> category.</p>`;
            return;
          }

          renderAssetTable(currentAssets); // Render the table with all fetched assets
        } catch (err) {
          tableWrapper.innerHTML = `<p style='color:red;'>Failed to load assets: ${err.message}.</p>`;
          console.error("Failed to load assets for category:", err);
        }
      }

      /**
       * Applies filters (min price, max price, status) to the currently loaded assets
       * and re-renders the asset table.
       */
      function applyAssetFilters() {
        const min = parseFloat(document.getElementById("minPrice").value) || 0;
        const max =
          parseFloat(document.getElementById("maxPrice").value) ||
          Number.MAX_VALUE;
        const status = document.getElementById("statusFilter").value;

        // Filter the global `currentAssets` array
        const filtered = currentAssets.filter((asset) => {
          const price = parseFloat(asset.value);
          const matchesPrice = price >= min && price <= max;
          const matchesStatus = status ? asset.status === status : true; // If status is empty, match all statuses
          return matchesPrice && matchesStatus;
        });

        renderAssetTable(filtered); // Render the table with filtered assets
      }

      /**
       * Renders an array of asset objects into an HTML table.
       * @param {Array<Object>} assets - An array of asset objects to display.
       */
      function renderAssetTable(assets) {
        const tableWrapper = document.getElementById("assetListTable");
        if (assets.length === 0) {
          tableWrapper.innerHTML =
            "<p style='color: gray;'>No assets match the current filters.</p>";
          return;
        }

        const table = document.createElement("table");
        table.setAttribute("role", "table");
        table.setAttribute(
          "aria-label",
          `List of ${currentCategoryName} Assets`
        ); // Dynamic ARIA label

        table.innerHTML = `
                    <thead>
                        <tr>
                            <th role="columnheader">Name</th>
                            <th role="columnheader">Description</th>
                            <th role="columnheader">Status</th>
                            <th role="columnheader">Value (â‚¹)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${assets
                          .map(
                            (asset) => `
                            <tr role="row">
                                <td role="cell">${asset.name}</td>
                                <td role="cell">${asset.description}</td>
                                <td role="cell">${asset.status}</td>
                                <td role="cell">${
                                  asset.value
                                    ? asset.value.toLocaleString("en-IN", {
                                        style: "currency",
                                        currency: "INR",
                                      })
                                    : "N/A"
                                }</td>
                                <td class="action-cell">
                                    <span class="delete-icon" data-id="${
                                      asset.id
                                    }" title="Delete Asset"><i class="fa-solid fa-trash"></i></span>
                                    <span class="edit-icon" data-id="${
                                      asset.id
                                    }" title="Edit Asset"><i class="fa-solid fa-pen"></i></span>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                `;
        tableWrapper.innerHTML = ""; // Clear previous content
        tableWrapper.appendChild(table);

        // Attach event listeners for Delete buttons
        const deleteIcons = table.querySelectorAll(".delete-icon");
        deleteIcons.forEach((icon) => {
          icon.addEventListener("click", async function () {
            const assetId = this.getAttribute("data-id");
            showMessageBox(
              "Are you sure you want to delete this asset?",
              "info",
              "Confirm Deletion",
              async () => {
                try {
                  const response = await fetch(`/api/assets/${assetId}`, {
                    method: "DELETE",
                  });
                  if (response.ok) {
                    showMessageBox("Asset deleted successfully", "success");
                    // Re-fetch and re-render the table after deletion
                    showAssetsTable(currentCategoryId, currentCategoryName);
                  } else {
                    const errorText = await response.text();
                    showMessageBox(
                      `Failed to delete asset: ${errorText}`,
                      "error"
                    );
                  }
                } catch (error) {
                  showMessageBox("Network error while deleting", "error");
                  console.error("Delete error:", error);
                }
              },
              true // Pass true to show "Cancel" button
            );
          });
        });

        // Attach event listeners for Edit buttons
        const editIcons = table.querySelectorAll(".edit-icon");
        editIcons.forEach((icon) => {
          icon.addEventListener("click", function () {
            const assetId = this.getAttribute("data-id");
            // Find the asset object from the globally stored currentAssets array
            const assetToEdit = currentAssets.find((a) => a.id == assetId);

            if (!assetToEdit) {
              showMessageBox("Asset not found for editing", "error");
              return;
            }

            // Call showAddAssetForm() first to reset and show the form container
            showAddAssetForm();

            // ðŸ”¥ðŸ”¥ðŸ”¥ THIS IS THE CRUCIAL PART: PRE-FILL THE FORM FIELDS ðŸ”¥ï¿½ðŸ”¥
            document.getElementById("assetName").value = assetToEdit.name;
            document.getElementById("assetDescription").value =
              assetToEdit.description;
            document.getElementById("assetValue").value = assetToEdit.value;
            document.getElementById("assetStatus").value = assetToEdit.status;

            // Pre-select the category in the dropdown
            if (assetToEdit.category && assetToEdit.category.id) {
              document.getElementById("assetCategory").value =
                assetToEdit.category.id;
            } else {
              document.getElementById("assetCategory").value = ""; // Default to "Select Category"
            }

            // Set the form in edit mode by storing the asset ID
            document
              .getElementById("newAssetForm")
              .setAttribute("data-edit-id", assetId);

            // Update the form title and button text for edit mode
            document.querySelector("#addAssetFormContainer h2").textContent =
              "Edit Asset";
            document.querySelector(
              "#newAssetForm button[type='submit']"
            ).textContent = "Update Asset";
          });
        });
      }

      /**
       * Shows the "Add New Asset" form and hides other asset management elements.
       * This function is now smart enough to either prepare for adding or for editing.
       */
      function showAddAssetForm() {
        document.getElementById("assetCategoryGrid").style.display = "none"; // Hide category grid
        document.getElementById("assetFilterControls").style.display = "none"; // Hide filters
        document.getElementById("assetListTable").style.display = "none"; // Hide asset table
        document.getElementById("addAssetFormContainer").style.display = "flex"; // Show the form

        // Load categories into the dropdown every time the form is shown
        loadCategories();

        // Reset form fields
        document.getElementById("newAssetForm").reset();

        // Default to "Add New Asset" mode
        document.querySelector("#addAssetFormContainer h2").textContent =
          "Add New Asset";
        document.querySelector(
          "#newAssetForm button[type='submit']"
        ).textContent = "Add Asset";
        document.getElementById("newAssetForm").removeAttribute("data-edit-id"); // Clear any previous edit ID
        document.getElementById("assetCategory").value = ""; // Ensure category dropdown is reset
      }

      /**
       * Hides the "Add New Asset" form and brings back the category grid or asset table/filters.
       */
      function hideAddAssetForm() {
        document.getElementById("addAssetFormContainer").style.display = "none";

        // Debug: Show what currentCategoryId is
        console.log("Hiding form. Current Category ID:", currentCategoryId);

        if (
          currentCategoryId !== null &&
          typeof currentCategoryId !== "undefined"
        ) {
          // Show filter and asset list if a category is selected
          document.getElementById("assetFilterControls").style.display = "flex";
          document.getElementById("assetListTable").style.display = "block";

          // Re-render or re-fetch assets
          showAssetsTable(currentCategoryId, currentCategoryName); // Always re-fetch to ensure latest data
        } else {
          // No category selected â€“ show the grid again
          document.getElementById("assetCategoryGrid").style.display = "grid";
        }
        // Ensure form is reset to "Add" mode when hidden
        document.querySelector("#addAssetFormContainer h2").textContent =
          "Add New Asset";
        document.querySelector(
          "#newAssetForm button[type='submit']"
        ).textContent = "Add Asset";
        document.getElementById("newAssetForm").removeAttribute("data-edit-id");
        document.getElementById("assetCategory").value = ""; // Ensure category dropdown is reset
      }

      /**
       * Shows a custom message box instead of alert/confirm.
       * @param {string} message - The message to display.
       * @param {string} type - 'success', 'error', 'info'.
       * @param {string} title - The title of the message box.
       * @param {Function} [onConfirm] - Optional callback function for 'OK' or 'Confirm'.
       * @param {boolean} [showCancelButton=false] - Whether to show a 'Cancel' button.
       */
      function showMessageBox(
        message,
        type = "info",
        title = "",
        onConfirm = null,
        showCancelButton = false
      ) {
        const overlay = document.getElementById("messageBoxOverlay");
        const messageBox = overlay.querySelector(".message-box");
        const messageBoxTitle = document.getElementById("messageBoxTitle");
        const messageBoxContent = document.getElementById("messageBoxContent");
        let okButton = messageBox.querySelector("button");
        let cancelButton = messageBox.querySelector("#messageBoxCancelBtn");

        // Create cancel button if it doesn't exist
        if (!cancelButton) {
          cancelButton = document.createElement("button");
          cancelButton.id = "messageBoxCancelBtn";
          cancelButton.textContent = "Cancel";
          cancelButton.style.marginLeft = "10px";
          cancelButton.style.backgroundColor = "#95a5a6"; // Gray
          cancelButton.onclick = hideMessageBox;
          okButton.parentNode.appendChild(cancelButton);
        }

        // Reset classes
        messageBox.classList.remove("success", "error", "info");
        messageBox.classList.add(type);

        // Set title based on type if not provided
        if (!title) {
          switch (type) {
            case "success":
              title = "Success!";
              break;
            case "error":
              title = "Error!";
              break;
            case "info":
              title = "Information";
              break;
            default:
              title = "Notification";
          }
        }

        messageBoxTitle.textContent = title;
        messageBoxContent.textContent = message;
        overlay.classList.add("show");

        // Set up OK button action
        okButton.onclick = () => {
          hideMessageBox();
          if (onConfirm) {
            onConfirm();
          }
        };

        // Show/hide cancel button
        if (showCancelButton) {
          cancelButton.style.display = "inline-block";
        } else {
          cancelButton.style.display = "none";
        }
      }

      /**
       * Fetches asset categories from the API and populates the assetCategory dropdown.
       */
      async function loadCategories() {
        try {
          const response = await fetch("/api/asset-categories");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const categories = await response.json();

          const select = document.getElementById("assetCategory");
          select.innerHTML = '<option value="">-- Select Category --</option>'; // Clear existing options

          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading categories for dropdown:", error);
          showMessageBox("Failed to load categories for dropdown.", "error");
        }
      }

      function hideMessageBox() {
        document.getElementById("messageBoxOverlay").classList.remove("show");
      }

      document
        .getElementById("newAssetForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const assetId = this.getAttribute("data-edit-id"); // Get asset ID if in edit mode
          const assetName = document.getElementById("assetName").value;
          const assetDescription =
            document.getElementById("assetDescription").value;
          const assetValue = parseFloat(
            document.getElementById("assetValue").value
          );
          const assetStatus = document.getElementById("assetStatus").value;
          const categoryId = parseInt(
            document.getElementById("assetCategory").value
          ); // Get selected category ID

          if (
            !assetName ||
            isNaN(assetValue) ||
            assetValue < 0 ||
            !assetStatus ||
            isNaN(categoryId) ||
            categoryId === null ||
            categoryId === 0 // Check if a category is actually selected
          ) {
            showMessageBox(
              "Please fill in all required fields and select a category.",
              "error"
            );
            return;
          }

          const payload = {
            name: assetName,
            description: assetDescription,
            value: assetValue,
            status: assetStatus,
            category: {
              // Include category ID in the payload
              id: categoryId,
            },
          };

          const method = assetId ? "PUT" : "POST";
          const endpoint = assetId ? `/api/assets/${assetId}` : `/api/assets`;

          try {
            const response = await fetch(endpoint, {
              method: method,
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              showMessageBox(
                assetId ? "Asset updated!" : "Asset added!",
                "success"
              );
              hideAddAssetForm(); // This will re-fetch and re-render the table
            } else {
              const errorData = await response
                .json()
                .catch(() => ({ message: response.statusText }));
              showMessageBox(`Error: ${errorData.message}`, "error");
              console.error("API Error:", errorData);
            }
          } catch (error) {
            showMessageBox(`Network error: ${error.message}`, "error");
            console.error("Fetch error:", error);
          }
        });

      // Initialize the dashboard on page load
      document.addEventListener("DOMContentLoaded", () => {
        showSection("dashboard", document.getElementById("dashboard-link"));
        // Add a cancel button to the message box once DOM is ready
        const messageBox = document.querySelector(".message-box");
        if (!messageBox.querySelector("#messageBoxCancelBtn")) {
          const okButton = messageBox.querySelector("button");
          const cancelButton = document.createElement("button");
          cancelButton.id = "messageBoxCancelBtn";
          cancelButton.textContent = "Cancel";
          cancelButton.style.marginLeft = "10px";
          cancelButton.style.backgroundColor = "#95a5a6"; // Gray
          cancelButton.onclick = hideMessageBox;
          okButton.parentNode.appendChild(cancelButton);
          cancelButton.style.display = "none"; // Hide by default
        }
      });
      function handleLogout() {
        // 1. Show message (optional)
        showMessageBox("Logging out...", "info");

        // 2. Clear session storage/local storage
        sessionStorage.clear();
        localStorage.clear();

        setTimeout(() => {
          window.location.href = "/index.html"; // change to your login page path
        }, 1000);
      }
    let departments = [];
let selectedDepartmentId = null;
let allEmployees = [];

// This function determines the icon based on the department name
function getIconForDepartment(name) {
    if (!name) return "fa-folder"; // Default icon if name is null or empty
    switch (name.toLowerCase()) {
        case "corporate finance":
            return "fa-chart-line"; // Example: financial icon
        case "human resources":
            return "fa-users"; // Example: people icon
        case "marketing & business development":
            return "fa-bullhorn"; // Example: megaphone icon
        case "project & construction management":
            return "fa-hard-hat"; // Example: construction icon
        case "engineering services (mechanical)":
            return "fa-cogs"; // Example: gears icon
        case "engineering services (electrical)":
            return "fa-bolt"; // Example: lightning icon
        case "engineering services (civil & structural)":
            return "fa-drafting-compass"; // Example: compass icon
        case "information technology services":
            return "fa-laptop-code"; // Example: laptop icon
        case "research & development":
            return "fa-flask"; // Example: flask icon
        case "quality assurance & inspection":
            return "fa-check-double"; // Example: checkmark icon
        case "procurement & stores":
            return "fa-boxes"; // Example: boxes icon
        case "legal & contracts":
            return "fa-gavel"; // Example: gavel icon
        case "administration":
            return "fa-clipboard-list"; // Example: clipboard icon
        case "environmental engineering":
            return "fa-leaf"; // Example: leaf icon
        case "metals division":
            return "fa-industry"; // Example: factory icon
        case "power division":
            return "fa-charging-station"; // Example: power station icon
        case "oil & gas division":
            return "fa-gas-pump"; // Example: gas pump icon
        case "infrastructure division":
            return "fa-city"; // Example: city icon
        case "ispat hospital":
            return "fa-hospital"; // Example: hospital icon
        case "corporate communication":
            return "fa-comments"; // Example: chat bubbles icon
        default:
            return "fa-building"; // Default icon for any other department
    }
}

window.onload = async () => {
    await loadDepartments();
};

async function loadDepartments() {
    try {
        const res = await fetch("/api/departments");
        if (!res.ok) throw new Error("Failed to fetch departments");
        departments = await res.json();

        const grid = document.getElementById("departmentCategoryGrid");
        grid.innerHTML = "";
        departments.forEach((dept) => {
            // Use dept.departmentName for the function call
            const iconClass = getIconForDepartment(dept.departmentName); // Corrected: use dept.departmentName
            const card = document.createElement("div");
            card.className = "card";
            // Add ARIA attributes for grid items
            card.setAttribute("role", "gridcell");
            card.setAttribute("tabindex", "0"); // Make div focusable
            card.setAttribute("aria-label", `View ${dept.departmentName} department`); // Corrected: use dept.departmentName
            card.innerHTML = `
                <div class="asset-icon"><i class="fas ${iconClass}" aria-hidden="true"></i></div>
                <h3>${dept.departmentName}</h3> `;
            // Use a common function for click handler to pass both ID and Name
            card.onclick = () => loadEmployees(dept.id); // Corrected: calls loadEmployees directly
            // Add keyboard accessibility for Enter key
            card.onkeydown = (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault(); // Prevent default scroll for space bar
                    loadEmployees(dept.id); // Corrected: calls loadEmployees directly
                }
            };
            grid.appendChild(card);
        });

        // Populate <select> in add form
        const deptSelect = document.getElementById("employeeDepartment");
        deptSelect.innerHTML = '<option value="">-- Select Department --</option>'; // Clear existing options
        departments.forEach((dept) => {
            const option = document.createElement("option");
            option.value = dept.id;
            option.textContent = dept.departmentName; // Correct: use dept.departmentName
            deptSelect.appendChild(option);
        });
    } catch (err) {
        console.error("Error loading departments:", err);
        // Optionally display an error message to the user
        document.getElementById("departmentCategoryGrid").innerHTML = "<p>Error loading departments. Please try again later.</p>";
    }
}

async function loadEmployees(departmentId) {
    selectedDepartmentId = departmentId;
    document.getElementById("employeeFilterControls").style.display = "flex";

    try {
        const res = await fetch(`http://localhost:8080/api/employees/department/${departmentId}`);
        if (!res.ok) throw new Error("Failed to fetch employees");
        allEmployees = await res.json();
        displayEmployees(allEmployees);
    } catch (err) {
        console.error("Error loading employees:", err);
        document.getElementById("employeeListTable").innerHTML = "<p>Error loading employees. Please try again later.</p>";
    }
}

function displayEmployees(employeeList) {
    const tableDiv = document.getElementById("employeeListTable");
    if (employeeList.length === 0) {
        tableDiv.innerHTML = "<p>No employees found.</p>";
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>id</th><th>Name</th><th>Email</th><th>Phone</th><th>Designation</th><th>Join Date</th>
                </tr>
            </thead>
            <tbody>
    `;

    employeeList.forEach(emp => {
        html += `
            <tr>
                <td>${emp.id}</td>
                <td>${emp.name}</td>
                <td>${emp.email}</td>
                <td>${emp.phone}</td>
                <td>${emp.designation}</td>
                <td>${emp.joinDate}</td>
            </tr>
        `;
    });

    html += "</tbody></table>";
    tableDiv.innerHTML = html;
}

function applyEmployeeFilters() {
    const nameFilter = document.getElementById("employeeNameFilter").value.toLowerCase();
    const emailFilter = document.getElementById("employeeEmailFilter").value.toLowerCase();
    const phoneFilter = document.getElementById("employeePhoneFilter").value.toLowerCase();
    const minDate = document.getElementById("joinDateMin").value;
    const maxDate = document.getElementById("joinDateMax").value;
    // You might still want to keep designation filter if it's separate from a general name search
    // const designationFilter = document.getElementById("designationFilter").value.toLowerCase();


    const filtered = allEmployees.filter(emp => {
        // Filter by Name
        const matchName = !nameFilter || emp.name.toLowerCase().includes(nameFilter);

        // Filter by Email
        const matchEmail = !emailFilter || emp.email.toLowerCase().includes(emailFilter);

        // Filter by Phone
        const matchPhone = !phoneFilter || emp.phone.toLowerCase().includes(phoneFilter);

        // Filter by Join Date (existing logic)
        const joinDate = emp.joinDate; // Assuming emp.joinDate is in 'YYYY-MM-DD' format from your backend
        const matchMinDate = !minDate || joinDate >= minDate;
        const matchMaxDate = !maxDate || joinDate <= maxDate;

        // Combine all filter conditions
        return matchName && matchEmail && matchPhone && matchMinDate && matchMaxDate;
    });

    displayEmployees(filtered);
}

function showAddEmployeeForm() {
    document.getElementById("addEmployeeFormContainer").style.display = "block";
}

function hideAddEmployeeForm() {
    document.getElementById("addEmployeeFormContainer").style.display = "none";
}

document.getElementById("newEmployeeForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const emp = {
        name: document.getElementById("employeeName").value,
        email: document.getElementById("employeeEmail").value,
        phone: document.getElementById("employeePhone").value,
        joinDate: document.getElementById("employeeJoinDate").value,
        designation: document.getElementById("employeeDesignation").value,
        department: { id: parseInt(document.getElementById("employeeDepartment").value) }
    };

    try {
        const res = await fetch("http://localhost:8080/api/employees", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(emp)
        });
        if (!res.ok) throw new Error("Failed to add employee");
        // Reload employees for the currently selected department to show the new one
        if (selectedDepartmentId) {
            await loadEmployees(selectedDepartmentId);
        } else {
            // If no department was selected (shouldn't happen if UI flow is followed),
            // you might want to reload departments or handle differently.
            console.warn("Employee added but no department was selected to refresh.");
        }
        this.reset();
        hideAddEmployeeForm();
    } catch (err) {
        console.error("Error adding employee:", err);
        alert("Failed to add employee. Please check the console for details.");
    }
});
         document.addEventListener('DOMContentLoaded', async () => {
            const assetSelect = document.getElementById('assetSelect');
            const employeeIdInput = document.getElementById('employeeIdInput');
            const assignForm = document.getElementById('assignForm');
            const assignResult = document.getElementById('assignResult');

            // Function to display messages
            function showMessage(message, type) {
                assignResult.textContent = message;
                assignResult.className = `result-message show ${type}`; // Reset classes and add new ones
                setTimeout(() => {
                    assignResult.classList.remove('show');
                    // Optionally clear text after animation
                    setTimeout(() => assignResult.textContent = '', 400);
                }, 3000); // Message disappears after 3 seconds
            }

            // Function to fetch assets and populate the dropdown with only AVAILABLE assets
           async function fetchAssets() {
    try {
        const response = await fetch('/api/assets/available'); // only unassigned assets
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const assets = await response.json();
        assetSelect.innerHTML = '<option value="">-- Select an Available Asset --</option>';

        if (assets.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No available assets";
            option.disabled = true;
            assetSelect.appendChild(option);
        } else {
            assets.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.id;
                option.textContent = `${asset.name} (ID: ${asset.id})- Status: ${asset.status}`;
                assetSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error fetching assets:', error);
        showMessage('Failed to load assets. Please try again.', 'error');
    }
}

            // Initial fetch of assets when the page loads
            await fetchAssets();

            // Handle Assign Form Submission
            assignForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const assetId = assetSelect.value;
                const employeeId = employeeIdInput.value.trim();

                if (!assetId) {
                    showMessage('Please select an asset.', 'error');
                    return;
                }
                if (!employeeId) {
                    showMessage('Please enter an Employee ID.', 'error');
                    return;
                }

                // Basic validation for employeeId to be a number
                if (isNaN(employeeId) || employeeId <= 0) {
                    showMessage('Employee ID must be a valid positive number.', 'error');
                    return;
                }

                try {
                    const response = await fetch(`/api/assets/assign/${assetId}`, {
                        method: 'PUT', // Or 'POST' if preferred, PUT for updating a resource
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ employeeId: parseInt(employeeId, 10) }) // Ensure employeeId is a number
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    showMessage(result.message, 'success');
                    await fetchAssets(); // Re-fetch assets to update their status in the dropdown
                    employeeIdInput.value = ''; // Clear employee ID input
                    assetSelect.value = ''; // Clear asset selection
                } catch (error) {
                    console.error('Error assigning asset:', error);
                    showMessage(`Error assigning asset: ${error.message}`, 'error');
                }
            });

        });
      $(document).ready(function() {
    console.log("jQuery is ready! Reports script started."); // Debugging line

    const reportTypeSelect = $('#reportType');
    const reportFiltersDiv = $('.report-controls');
    const generateReportBtn = $('#generateReportBtn');
    const reportContentDiv = $('#reportContent');
    const reportTitle = $('#reportTitle');
    const noReportMessage = $('#noReportMessage');
    const reportActionsDiv = $('.report-actions');
    const downloadPdfBtn = $('#downloadPdfBtn');
    const downloadCsvBtn = $('#downloadCsvBtn');
    const printReportBtn = $('#printReportBtn');

    const filterCategory = $('#filterCategory');
    const filterStatus = $('#filterStatus');
    const filterDepartment = $('#filterDepartment');
    const filterJoinDateStart = $('#filterJoinDateStart');
    const filterJoinDateEnd = $('#filterJoinDateEnd');

    // Function to fetch departments and populate the dropdown
    function fetchDepartments() {
        console.log("Fetching departments..."); // Debugging line
        $.ajax({
            url: '/api/departments',
            method: 'GET',
            success: function(data) {
                console.log("Departments fetched:", data); // Debugging line
                let options = '<option value="">All Departments</option>';
                data.forEach(dept => {
                    options += `<option value="${dept.id}">${dept.departmentName}</option>`;
                });
                filterDepartment.html(options);
            },
            error: function(xhr, status, error) {
                console.error("Error fetching departments:", xhr.responseText || error);
                // alert("Failed to load departments. Check console for details."); // Removed for less intrusive debugging
            }
        });
    }

    // Function to fetch asset categories and populate the dropdown
    function fetchAssetCategories() {
        console.log("Fetching asset categories..."); // Debugging line
        $.ajax({
            url: '/api/asset-categories',
            method: 'GET',
            success: function(data) {
                console.log("Asset categories fetched:", data); // Debugging line
                let options = '<option value="">All Categories</option>';
                data.forEach(cat => {
                    options += `<option value="${cat.id}">${cat.name}</option>`;
                });
                filterCategory.html(options);
            },
            error: function(xhr, status, error) {
                console.error("Error fetching asset categories:", xhr.responseText || error);
                // alert("Failed to load asset categories. Check console for details."); // Removed for less intrusive debugging
            }
        });
    }

    // Initial fetch for filter options when the page loads
    fetchDepartments();
    fetchAssetCategories();

    reportTypeSelect.on('change', function() {
        const selectedReport = $(this).val();
        console.log("Report type changed to:", selectedReport); // Debugging line
        reportFiltersDiv.find('.form-group').hide(); // Hide all filters by default

        switch (selectedReport) {
            case 'assetInventory':
                $('.filter-category').show();
                $('.filter-status').show();
                break;
            case 'employeeDetails':
                $('.filter-department').show();
                $('.filter-join-date-start').show();
                $('.filter-join-date-end').show();
                break;
            default:
                break;
        }
        reportContentDiv.empty();
        reportTitle.hide();
        reportActionsDiv.hide();
        noReportMessage.show();
    });

    generateReportBtn.on('click', function() {
        const selectedReport = reportTypeSelect.val();
        let apiUrl = '';
        let queryParams = {};
        let reportHeading = 'Generated Report';

        console.log("Generate Report button clicked. Selected Report Type:", selectedReport); // Debugging line

        reportContentDiv.empty();
        reportTitle.hide();
        reportActionsDiv.hide();
        noReportMessage.hide();

        if (!selectedReport) {
            alert('Please select a report type.');
            noReportMessage.show();
            return;
        }

        switch (selectedReport) {
            case 'assetInventory':
                apiUrl = '/api/reports/asset-inventory'; // Match your Spring Boot Controller path
                queryParams.categoryId = filterCategory.val();
                queryParams.status = filterStatus.val();
                reportHeading = 'Asset Inventory Report';
                break;
            case 'employeeDetails':
                apiUrl = '/api/reports/employee-details'; // Match your Spring Boot Controller path
                queryParams.departmentId = filterDepartment.val();
                queryParams.joinDateStart = filterJoinDateStart.val();
                queryParams.joinDateEnd = filterJoinDateEnd.val();
                reportHeading = 'Employee Details Report';
                break;
            default:
                console.warn("Unknown report type selected.");
                noReportMessage.show();
                return;
        }

        // Remove empty/null/undefined query parameters
        for (const key in queryParams) {
            if (queryParams[key] === null || queryParams[key] === undefined || queryParams[key] === '') {
                delete queryParams[key];
            }
        }
        console.log("Calling API:", apiUrl, "with params:", queryParams); // Debugging line

        $.ajax({
            url: apiUrl,
            method: 'GET',
            data: queryParams,
            success: function(data) {
                console.log("API response received:", data); // Debugging line
                if (data && data.length > 0) {
                    let tableHtml = '<table class="report-table"><thead><tr>';
                    const headers = Object.keys(data[0]);

                    headers.forEach(header => {
                        tableHtml += `<th>${formatHeader(header)}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    data.forEach(row => {
                        tableHtml += '<tr>';
                        headers.forEach(header => {
                            let cellValue = row[header] !== null && row[header] !== undefined ? row[header] : '';
                            if (header === 'value' && typeof cellValue === 'number') {
                                cellValue = cellValue.toFixed(2); // Format currency/value
                            } else if (header.toLowerCase().includes('date') && cellValue) {
                                try {
                                    const dateObj = new Date(cellValue);
                                    if (!isNaN(dateObj.getTime())) {
                                        cellValue = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                    }
                                } catch (e) {
                                    console.error("Error formatting date:", cellValue, e);
                                }
                            }
                            tableHtml += `<td>${cellValue}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                    reportContentDiv.html(tableHtml);
                    reportTitle.text(reportHeading).show();
                    reportActionsDiv.show();
                } else {
                    reportContentDiv.html('<p class="text-center">No data found for the selected criteria.</p>');
                    reportTitle.text(reportHeading).show();
                    reportActionsDiv.hide();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error generating report:", error, "Response Text:", xhr.responseText);
                let errorMessage = `Error loading report: ${xhr.status} ${xhr.statusText}`;
                try {
                    const errorJson = JSON.parse(xhr.responseText);
                    errorMessage += ` - ${errorJson.message || errorJson.error || 'Unknown error'}`;
                } catch (e) {
                    errorMessage += ` - ${xhr.responseText || error}`;
                }
                reportContentDiv.html(`<p style="color: red;">${errorMessage}</p>`); // Simple styling without Bootstrap
                reportTitle.hide();
                reportActionsDiv.hide();
                noReportMessage.show();
            }
        });
    });

    function formatHeader(header) {
        const headerMap = {
            'id': 'ID',
            'name': 'Name',
            'description': 'Description',
            'value': 'Value',
            'status': 'Status',
            'categoryName': 'Category',
            'assignedToEmployeeName': 'Assigned To',
            'departmentName': 'Department',
            'designation': 'Designation',
            'email': 'Email',
            'phone': 'Phone',
            'joinDate': 'Join Date',
            'assetId': 'Asset ID',
            'employeeName': 'Employee Name'
        };
        return headerMap[header] || header
            .replace(/([A-Z])/g, ' $1')
            .replace(/^./, str => str.toUpperCase());
    }

    downloadPdfBtn.on('click', function() {
        const selectedReport = reportTypeSelect.val();
        let queryParams = {};
        let pdfDownloadUrl = '';

        console.log("Download PDF button clicked. Selected Report Type:", selectedReport);

        switch (selectedReport) {
            case 'assetInventory':
                queryParams.categoryId = filterCategory.val();
                queryParams.status = filterStatus.val();
                pdfDownloadUrl = '/api/downloads/assets/pdf'; // Match your Spring Boot Controller path
                break;
            case 'employeeDetails':
                queryParams.departmentId = filterDepartment.val();
                queryParams.joinDateStart = filterJoinDateStart.val();
                queryParams.joinDateEnd = filterJoinDateEnd.val();
                pdfDownloadUrl = '/api/downloads/employees/pdf'; // Match your Spring Boot Controller path
                break;
            default:
                alert('Please select a report type to download PDF.');
                return;
        }

        for (const key in queryParams) {
            if (queryParams[key] === null || queryParams[key] === undefined || queryParams[key] === '') {
                delete queryParams[key];
            }
        }

        const queryString = $.param(queryParams);
        const fullPdfUrl = `http://localhost:8080${pdfDownloadUrl}${queryString ? '?' + queryString : ''}`;

        console.log("Attempting to download PDF from URL:", fullPdfUrl);

        fetch(fullPdfUrl)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to download PDF: ${response.status} ${response.statusText} - ${text}`);
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = `${selectedReport.replace(/([A-Z])/g, '-$1').toLowerCase()}_Report_${new Date().toISOString().slice(0,10)}.pdf`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                console.log("PDF download initiated successfully.");
            })
            .catch(error => {
                console.error('Error during PDF download request:', error);
                alert('An error occurred while trying to download the PDF. Please check console for details and ensure the backend server is running and accessible.');
            });
    });

    downloadCsvBtn.on('click', function() {
        const selectedReport = reportTypeSelect.val();
        const table = $('#reportContent table');
        if (table.length === 0) {
            alert("No report data to download.");
            return;
        }

        let csv = [];
        table.find('thead tr').each(function() {
            let row = [];
            $(this).find('th').each(function() {
                row.push(`"${$(this).text().trim().replace(/"/g, '""')}"`);
            });
            csv.push(row.join(','));
        });
        table.find('tbody tr').each(function() {
            let row = [];
            $(this).find('td').each(function() {
                row.push(`"${$(this).text().trim().replace(/"/g, '""')}"`);
            });
            csv.push(row.join(','));
        });

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', `${selectedReport}_report.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log("CSV download initiated.");
    });

    printReportBtn.on('click', function() {
        const printContent = $('#reportContent').html();
        if (!printContent || printContent.trim() === '<p class="text-center">No data found for the selected criteria.</p>') {
             alert("No report data to print.");
             return;
        }
        console.log("Print report button clicked.");
        const originalBody = $('body').html();
        $('body').empty().append(printContent);
        window.print();
        $('body').empty().append(originalBody);
        location.reload();
    });
});
    </script>
  </body>
</html>
